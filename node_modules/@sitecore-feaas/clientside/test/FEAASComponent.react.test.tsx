import React from 'react'
import ReactDOM from 'react-dom'
import { describe, expect, it } from 'vitest'
import { Component } from '../src/ui/react.js'

async function test(react: any, html: string) {
  const div = document.createElement('div')
  document.body.appendChild(div)
  const root = ReactDOM.render(react, div)
  expect(div.innerHTML).toEqual(html)

  const div2 = document.createElement('div')
  document.body.appendChild(div2)
  div2.innerHTML = html

  var onHydrate
  const promise = new Promise((r) => {
    onHydrate = r
  })
  ReactDOM.hydrate(react, div2, onHydrate)
  await promise
  expect(div2.innerHTML).toEqual(html)
}

describe('React', () => {
  it('render react component', async () => {
    await test(
      <section>
        <Component src='library/test'></Component>
      </section>,
      '<section><feaas-component library="library" component="test" src="library/test"></feaas-component></section>'
    )
  })
  it('render react with empty template', async () => {
    await test(
      <section>
        <Component src='library/test' template=''></Component>
      </section>,
      '<section><feaas-component library="library" component="test" src="library/test"></feaas-component></section>'
    )
  })
  it('render react component with src and overrides', async () => {
    await test(
      <section>
        <Component src='library/test' component='test2'></Component>
      </section>,
      '<section><feaas-component library="library" component="test2" src="library/test"></feaas-component></section>'
    )
  })
  it('render react component with extras', async () => {
    await test(
      <section>
        <Component src='library/test' version='v1'></Component>
      </section>,
      '<section><feaas-component library="library" component="test" version="v1" src="library/test"></feaas-component></section>'
    )
  })
  it('render react template', async () => {
    await test(
      <section>
        <Component src='library/test' template={'<div data-path-src="abc">'}></Component>
      </section>,
      '<section><feaas-component library="library" component="test" src="library/test"><div data-path-src="abc"></div></feaas-component></section>'
    )
  })
  it('render template with data and src', async () => {
    await test(
      <section>
        <Component src='library/test' template={'<div data-path-src="abc">'} data={{ abc: 321 }}></Component>
      </section>,
      '<section><feaas-component library="library" component="test" src="library/test" data="{&quot;abc&quot;:321}"><div data-path-src="abc"></div></feaas-component></section>'
    )
  })
  it('render template with data but without src', async () => {
    test(
      <section>
        <Component
          library='library'
          component='test'
          template={'<div data-path-src="abc">'}
          data={{ abc: 321 }}
        ></Component>
      </section>,
      '<section><feaas-component library="library" component="test" data="{&quot;abc&quot;:321}"><div data-path-src="abc"></div></feaas-component></section>'
    )
  })
  it('render template with data with src and stringy data', async () => {
    test(
      <section>
        <Component src='library/test' template={'<div data-path-src="abc">'} data={'{"abc":321}'}></Component>
      </section>,
      '<section><feaas-component library="library" component="test" src="library/test" data="{&quot;abc&quot;:321}"><div data-path-src="abc"></div></feaas-component></section>'
    )
  })
  it('render template with data and template', async () => {
    test(
      <section>
        <Component template={'<div data-path-src="abc">'} data={'{"abc":321}'}></Component>
      </section>,
      '<section><feaas-component data="{&quot;abc&quot;:321}"><div data-path-src="abc"></div></feaas-component></section>'
    )
  })
})
